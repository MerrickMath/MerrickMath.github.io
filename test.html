<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dr. Eureka – HARD Card Generator</title>
  <style>
    :root{
      --bg:#f7f9fc;
      --panel:#ffffff;
      --ink:#0f172a;
      --muted:#6b7280;
      --tube:#334155;
      --tubeFill:#ffffff;
      --red:#e74c3c;
      --green:#22c55e;
      --purple:#a855f7;
      --shadow: 0 6px 24px rgba(15,23,42,.10);
      --radius:16px;
    }
    html, body { height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 80% -10%, #eaf1ff 0%, var(--bg) 50%);
      color:var(--ink);
      font: 16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, 'Noto Sans';
    }
    .wrap{ max-width:900px; margin:auto; padding:24px 16px 36px; }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; }
    .brand{ display:flex; align-items:center; gap:10px; }
    h1{ font-size:20px; margin:0; letter-spacing:.2px; }
    #timer { font-size:16px; font-weight:600; color:var(--ink); }

    .panel{ background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px; }

    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn{
      appearance:none; border:1px solid #e5e7eb; cursor:pointer; padding:10px 14px; border-radius:10px;
      background:#ffffff; color:var(--ink); box-shadow: var(--shadow);
      transition: filter .15s ease, transform .02s ease; font-weight:600; letter-spacing:.2px;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{ transform: translateY(1px); }
    .btn.small{ padding:8px 10px; font-weight:600; }

    .card-area{ margin-top:12px; display:grid; grid-template-columns: 1fr; gap:12px; }
    .card{
      display:flex; align-items:center; justify-content:center; min-height:360px; padding:12px;
      background:#f8fafc; border-radius: var(--radius); box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .card h2{ position:absolute; top:10px; left:12px; margin:0; font-size:13px; color:var(--muted); }

    .info{ display:flex; gap:10px; color:var(--muted); font-size:12px; margin-top:6px; flex-wrap:wrap; }
    .info div{ background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; }

    @media print { .no-print{ display:none !important; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="no-print">
      <div class="brand">
        <h1>Dr. Eureka – HARD Card Generator</h1>
      </div>
      <div id="timer">00:00</div>
      <div class="row">
        <button id="prevBtn" class="btn small" title="Previous card (←)">◀ Prev</button>
        <button id="nextBtn" class="btn small" title="Next card (→)">Next ▶</button>
        <button id="newBtn" class="btn" title="New hard card (N)">New Card</button>
        <button id="printDeckBtn" class="btn">Print 100 Hard Cards</button>
        <span style="color:var(--muted); font-size:12px">Keyboard: <strong>N</strong> new, <strong>←/→</strong> history</span>
      </div>
    </header>

    <section class="card-area">
      <div class="card" id="card">
        <h2 id="cardTitle">Card</h2>
        <!-- SVG injected here -->
      </div>

      <div class="info no-print">
        <div>Seed: <span id="seedOut">–</span></div>
        <div>Card #: <span id="indexOut">1</span></div>
        <div>Difficulty: <span id="difficultyOut">Hard</span></div>
      </div>
    </section>
  </div>

  <script>
  // ===== Guarded global error handler (for easier debugging) =====
  window.addEventListener('error', (e)=>{
    console.error('[GlobalError]', e.message, e.filename+':'+e.lineno+':'+e.colno);
  });

  // ===== Timer logic =====
  let seconds=0; let timerId=null;
  function updateTimer(){
    seconds++;
    const m = String(Math.floor(seconds/60)).padStart(2,'0');
    const s = String(seconds%60).padStart(2,'0');
    const el = document.getElementById('timer');
    if(el) el.textContent = m+':'+s;
  }

  // ===== Seeded RNG =====
  function mulberry32(a){ return function(){ a|=0; a=a+0x6D2B79F5|0; let t=Math.imul(a^a>>>15,1|a); t=t+Math.imul(t^t>>>7,61|t)^t; return ((t^t>>>14)>>>0)/4294967296; } }
  function hashStringToSeed(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }
  function randomSeed(){ const chars='23456789ABCDEFGHJKLMNPQRSTUVWXYZ'; let s=''; for(let i=0;i<8;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }

  // ===== Model =====
  const TUBE_CAP=4;
  const START=[['P','P'],['G','G'],['R','R']]; // bottom..top per tube
  const COLOR_TO_HEX={R:'var(--red)',G:'var(--green)',P:'var(--purple)'};
  const VALID_COLORS=new Set(['R','G','P']);
  const clone=s=>s.map(t=>t.slice());
  const serialize=state=>state.map(t => t.join('')).join('|');

  function isValidState(state){
    return Array.isArray(state) && state.length===3 && state.every(t => Array.isArray(t) && t.length<=TUBE_CAP && t.every(c => VALID_COLORS.has(c)));
  }

  function moves(state){
    const res=[];
    for(let i=0;i<3;i++){
      if(state[i].length===0) continue;
      for(let j=0;j<3;j++){
        if(i===j) continue;
        if(state[j].length>=TUBE_CAP) continue;
        res.push([i,j]);
      }
    }
    return res;
  }
  function doMove(state,i,j){ const s=clone(state); const ball=s[i].pop(); s[j].push(ball); return s; }

  // BFS distance (for difficulty sanity checks)
  function shortestMoves(target){
    try{
      const targetKey=serialize(target), startKey=serialize(START);
      if(targetKey===startKey) return 0;
      const q=[START]; const dist=new Map([[startKey,0]]);
      while(q.length){
        const cur=q.shift(); const d=dist.get(serialize(cur));
        for(const [i,j] of moves(cur)){
          const nxt=doMove(cur,i,j); const key=serialize(nxt);
          if(!dist.has(key)){
            dist.set(key,d+1);
            if(key===targetKey) return d+1;
            q.push(nxt);
          }
        }
        if(dist.size>50000) break;
      }
      return null;
    }catch(err){ console.error('shortestMoves error:', err); return null; }
  }

  function generateTarget(rng){ // hard-only
    const minSteps=15, maxSteps=28;
    let best=null, bestDist=-1, attempts=0;
    while(attempts++<200){
      let s=clone(START), last=null;
      const steps=Math.floor(minSteps + rng()*(maxSteps-minSteps+1));
      for(let k=0;k<steps;k++){
        const all=moves(s).filter(m=>!(last && last[1]===m[0] && last[0]===m[1]));
        if(all.length===0) break;
        const [i,j]=all[Math.floor(rng()*all.length)];
        s=doMove(s,i,j); last=[i,j];
      }
      const d=shortestMoves(s); if(d===null) continue;
      if(d>bestDist){ best=s; bestDist=d; }
      if(best && d>=12) break; // hard threshold
    }
    return {state: isValidState(best)? best : START};
  }

  // ===== Rendering (SVG) with defensive color lookup =====
  function svgEl(tag,attrs={}){ const el=document.createElementNS('http://www.w3.org/2000/svg',tag); for(const [k,v] of Object.entries(attrs)) el.setAttribute(k,v); return el; }
  function renderCard(container,state){
    try{
      if(!container) return;
      if(!isValidState(state)) state = START;
      container.innerHTML='';
      const W=780,H=380;
      const svg=svgEl('svg',{viewBox:`0 0 ${W} ${H}`,width:'100%',height:'100%',role:'img','aria-label':'Dr. Eureka hard challenge'});
      const tubeW=120,tubeH=260,gap=90,baseY=300,startX=(W-(3*tubeW+2*gap))/2;

      for(let t=0;t<3;t++){
        const x=startX + t*(tubeW+gap);
        const tube=svgEl('g');
        const glass=svgEl('rect',{x:String(x),y:String(baseY-tubeH),width:String(tubeW),height:String(tubeH),rx:'32',ry:'32',fill:'var(--tubeFill)',stroke:'var(--tube)','stroke-width':'4'});
        const lip=svgEl('rect',{x:String(x-6),y:String(baseY-tubeH-10),width:String(tubeW+12),height:'18',rx:'10',ry:'10',fill:'#eef2f7',stroke:'var(--tube)','stroke-width':'2'});
        tube.appendChild(glass); tube.appendChild(lip);

        const balls=state[t];
        const slotH=(tubeH-32)/TUBE_CAP;
        const radius=Math.min(tubeW*0.28, slotH*0.45);
        for(let idx=0; idx<balls.length; idx++){
          const color=balls[idx];
          const cx=x + tubeW/2;
          const cy=baseY - 16 - slotH/2 - idx*slotH;
          const fill = COLOR_TO_HEX[color] || '#9ca3af'; // defensive fallback
          const c=svgEl('circle',{cx:String(cx),cy:String(cy),r:String(radius),fill,stroke:'#000','stroke-opacity':'.10','stroke-width':'1.5'});
          const shine=svgEl('circle',{cx:String(cx-10),cy:String(cy-10),r:String(radius*0.4),fill:'#fff','fill-opacity':'.18'});
          tube.appendChild(c); tube.appendChild(shine);
        }
        svg.appendChild(tube);
      }
      container.appendChild(svg);
    }catch(err){ console.error('renderCard error:', err); }
  }

  // ===== State & UI =====
  const history=[]; let currentIndex=-1; let GLOBAL_SEED=null;
  function pushHistory(entry){ history.push(entry); currentIndex=history.length-1; updateMeta(); }
  function current(){ return history[currentIndex]; }

  function updateMeta(){
    const entry=current(); if(!entry) return;
    renderCard(document.getElementById('card'), entry.state);
    const t1=document.getElementById('cardTitle'); if(t1) t1.textContent = 'Card – '+serialize(entry.state);
    const idxOut=document.getElementById('indexOut'); if(idxOut) idxOut.textContent = String(currentIndex+1);
    const diffOut=document.getElementById('difficultyOut'); if(diffOut) diffOut.textContent = 'Hard';
    const seedOut=document.getElementById('seedOut'); if(seedOut) seedOut.textContent = entry.seed;
  }

  function newHardCard(){
    if(!GLOBAL_SEED) GLOBAL_SEED = randomSeed();
    const rng = mulberry32(hashStringToSeed(GLOBAL_SEED + ':' + history.length));
    const {state} = generateTarget(rng);
    pushHistory({ state, seed: GLOBAL_SEED, diff: 'hard', diffLabel: 'Hard' });
  }

  // ===== Print Deck (returns window handle; warns if blocked) =====
  function openPrintDeck(seed, diff, count){
    const rng = mulberry32(hashStringToSeed(seed));
    const items = [];
    for(let k=0;k<count;k++){ const {state}=generateTarget(rng); items.push({state}); }

    const w = window.open('','_blank');
    if(!w) return null; // popup blocked

    const styles = `
      *{ box-sizing:border-box; }
      body{ margin:0; font:12px system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#fff; }
      .page{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; padding:10px; }
      .card{ border:1px solid #e5e7eb; border-radius:12px; padding:8px; height:360px; display:flex; align-items:center; justify-content:center; background:#ffffff; }
      @media print{ .page{ gap:8px; padding:8px; } .card{ height:340px; } }
    `;

    w.document.write('<!doctype html><html><head><meta charset="utf-8"><title>Print Deck</title><style>'+styles+'</style></head><body>');
    for(let i=0;i<items.length;i++){
      if(i%4===0) w.document.write('<div class="page">');
      w.document.write('<div class="card"><div id="c'+i+'"></div></div>');
      if(i%4===3) w.document.write('</div>');
    }
    if(items.length%4!==0) w.document.write('</div>');
    w.document.write('</body></html>');

    w.onload = () => {
      items.forEach((it, idx)=>{
        const host = w.document.getElementById('c'+idx);
        const W=380,H=300;
        const svg = w.document.createElementNS('http://www.w3.org/2000/svg','svg');
        svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
        svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
        const tubeW=95,tubeH=220,gap=50,baseY=260,startX=(W-(3*tubeW+2*gap))/2;
        for(let t=0;t<3;t++){
          const x=startX + t*(tubeW+gap);
          const glass=w.document.createElementNS('http://www.w3.org/2000/svg','rect');
          glass.setAttribute('x', String(x)); glass.setAttribute('y', String(baseY-tubeH));
          glass.setAttribute('width', String(tubeW)); glass.setAttribute('height', String(tubeH));
          glass.setAttribute('rx','28'); glass.setAttribute('ry','28');
          glass.setAttribute('fill','#fff'); glass.setAttribute('stroke','#334155'); glass.setAttribute('stroke-width','3');
          const lip=w.document.createElementNS('http://www.w3.org/2000/svg','rect');
          lip.setAttribute('x', String(x-5)); lip.setAttribute('y', String(baseY-tubeH-8));
          lip.setAttribute('width', String(tubeW+10)); lip.setAttribute('height','16');
          lip.setAttribute('rx','9'); lip.setAttribute('ry','9');
          lip.setAttribute('fill','#eef2f7'); lip.setAttribute('stroke','#334155'); lip.setAttribute('stroke-width','2');
          svg.appendChild(glass); svg.appendChild(lip);

          const balls=it.state[t];
          const slotH=(tubeH-28)/TUBE_CAP; const radius=Math.min(tubeW*0.26, slotH*0.45);
          for(let j=0;j<balls.length;j++){
            const col=balls[j]; const cx=x + tubeW/2; const cy=baseY - 14 - slotH/2 - j*slotH;
            const c=w.document.createElementNS('http://www.w3.org/2000/svg','circle');
            c.setAttribute('cx', String(cx)); c.setAttribute('cy', String(cy)); c.setAttribute('r', String(radius));
            c.setAttribute('fill', col==='R'?'#e74c3c': col==='G'?'#22c55e':'#a855f7');
            c.setAttribute('stroke','#000'); c.setAttribute('stroke-opacity','.10'); c.setAttribute('stroke-width','1.2');
            svg.appendChild(c);
          }
        }
        host.appendChild(svg);
      });
      w.focus(); w.print();
    };
    return w;
  }

  // ===== Wiring & Boot (DOM ready; safe binding) =====
  (function(){
    function safeBind(id, type, handler){ const el=document.getElementById(id); if(!el){ console.warn('Missing element #'+id+' — button disabled'); return; } el.addEventListener(type, handler); }
    function start(){
      seconds=0; if(timerId) clearInterval(timerId); timerId=setInterval(updateTimer,1000);
      GLOBAL_SEED = randomSeed();
      newHardCard();
      safeBind('newBtn','click', newHardCard);
      safeBind('nextBtn','click', ()=>{ const entry=current(); if(!entry) return; const nextIndex=history.length; const rng=mulberry32(hashStringToSeed(entry.seed+':'+nextIndex)); const {state}=generateTarget(rng); pushHistory({ state, seed: entry.seed, diff:'hard', diffLabel:'Hard' }); });
      safeBind('prevBtn','click', ()=>{ if(currentIndex>0){ currentIndex--; updateMeta(); } });
      safeBind('printDeckBtn','click', ()=>{ if(!GLOBAL_SEED) GLOBAL_SEED=randomSeed(); const w=openPrintDeck(GLOBAL_SEED,'hard',100); if(!w||w.closed) alert('Pop-up blocked. Allow pop-ups to use Print Deck.'); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='n'||e.key==='N'){ newHardCard(); } if(e.key==='ArrowRight'){ const b=document.getElementById('nextBtn'); if(b) b.click(); } if(e.key==='ArrowLeft'){ const b=document.getElementById('prevBtn'); if(b) b.click(); } });
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', start); else start();
  })();

  // ===== Minimal self-tests (run once on load; log to console) =====
  (function runSelfTests(){
    try{
      console.group('Self-tests');
      console.assert(COLOR_TO_HEX.R && COLOR_TO_HEX.G && COLOR_TO_HEX.P, 'Color map should include R/G/P');
      const rng=mulberry32(12345); const {state}=generateTarget(rng);
      console.assert(isValidState(state), 'Generated state must be valid');
      // Render smoke test off-DOM
      const tmp=document.createElement('div');
      renderCard(tmp, state); // should not throw
      console.assert(tmp.querySelector('svg'), 'Render should create an SVG');
      // Overlap test: ensure radius < slot spacing
      const tubeH=260, slotH=(tubeH-32)/TUBE_CAP; const radius=Math.min(120*0.28, slotH*0.45);
      console.assert(radius*2 < slotH*1.01, 'Ball diameter should be less than slot spacing');
      console.groupEnd();
    }catch(err){ console.error('Self-tests failed:', err); }
  })();

  </script>
</body>
</html>
